
# We'll change the source to avoid Windows TA from running unnecessary additional extractions, to speed up searches.
[sysmon-set-source]
SOURCE_KEY = MetaData:Source
REGEX = (.)
DEST_KEY = MetaData:Source
FORMAT = source::sysmon:wineventlog

[sysmon-set-host]
REGEX = <Computer>(.*?)</Computer>
DEST_KEY = MetaData::Host
FORMAT = host::$1

# Compress the data by throwing away unnecessary common bulk, saving 30-60% of license space, depending of event type.
# This gets rid of WinEventLog header info, which contains stuff that we already know: provider is sysmon, computername(=host), ..
[sysmon-shorten-data]
REGEX=<EventID>([^<]+)</EventID>.*?<EventRecordID>([^<]+)</EventRecordID>.*?<EventData>(.*)</EventData>
FORMAT=<Sysmon Type="$1" RecID="$2">$3</Sysmon>
DEST_KEY=_raw
DEPTH_LIMIT=100000
#WRITE_META=true
#LOOKAHEAD=8000

# Drop dns query events that query local names
#[sysmon-blacklist-dns]
#REGEX = ^<Sysmon Type="22".*'QueryName'>(?i)\.*(?:[^.<]+(?:local(?:domain)?)?|(?:[^<]+\.)?telia(?:sonera|company)?\.(?:com|net|fi|se|no|ee|lt)|[^<]+\.in-addr\.arpa\.)\.?<
#DEST_KEY = queue
#FORMAT = nullQueue

# Change the sourcetype to reflect the new data format.
[sysmon-set-sourcetype]
#SOURCE_KEY = MetaData:Sourcetype
#REGEX = sourcetype::([^:]*)
REGEX = ^<Sysmon(.)
DEST_KEY = MetaData:Sourcetype
FORMAT = sourcetype::sysmon:events

# Change sourcetype of Sysmon Event ID 1 = process created
[sysmon-set-st-1]
REGEX=^<Sysmon Type="1"
DEST_KEY=MetaData:Sourcetype
FORMAT=sourcetype::sysmon:events:processcreated

# Change sourcetype of Sysmon Event ID 2 = process changed file creation time
[sysmon-set-st-2]
REGEX=^<Sysmon Type="2"
DEST_KEY=MetaData:Sourcetype
FORMAT=sourcetype::sysmon:events:filectimechanged

# Change sourcetype of Sysmon Event ID 3 = network connection
[sysmon-set-st-3]
REGEX=^<Sysmon Type="3"
DEST_KEY=MetaData:Sourcetype
FORMAT=sourcetype::sysmon:events:networkconnect

# Change sourcetype of Sysmon Event ID 4 = sysmon service state changed
[sysmon-set-st-4]
REGEX=^<Sysmon Type="4"
DEST_KEY=MetaData:Sourcetype
FORMAT=sourcetype::sysmon:events:statechanged

# Change sourcetype of Sysmon Event ID 5 = process terminated
[sysmon-set-st-5]
REGEX=^<Sysmon Type="5"
DEST_KEY=MetaData:Sourcetype
FORMAT=sourcetype::sysmon:events:processterminated

# Change sourcetype of Sysmon Event ID 6 = driver loaded
[sysmon-set-st-6]
REGEX=^<Sysmon Type="6"
DEST_KEY=MetaData:Sourcetype
FORMAT=sourcetype::sysmon:events:driverloaded

# Change sourcetype of Sysmon Event ID 7 = image/dll loaded
[sysmon-set-st-7]
REGEX=^<Sysmon Type="7"
DEST_KEY=MetaData:Sourcetype
FORMAT=sourcetype::sysmon:events:imageloaded

# Change sourcetype of Sysmon Event ID 8 = create remote thread
[sysmon-set-st-8]
REGEX=^<Sysmon Type="8"
DEST_KEY=MetaData:Sourcetype
FORMAT=sourcetype::sysmon:events:createremotethread

# Change sourcetype of Sysmon Event ID 9 = raw access read using \\.\ notation
[sysmon-set-st-9]
REGEX=^<Sysmon Type="9"
DEST_KEY=MetaData:Sourcetype
FORMAT=sourcetype::sysmon:events:rawaccessread

# Change sourcetype of Sysmon Event ID 10 = process access
[sysmon-set-st-10]
REGEX=^<Sysmon Type="10"
DEST_KEY=MetaData:Sourcetype
FORMAT=sourcetype::sysmon:events:processaccess

# Change sourcetype of Sysmon Event ID 11 = file create
[sysmon-set-st-11]
REGEX=^<Sysmon Type="11"
DEST_KEY=MetaData:Sourcetype
FORMAT=sourcetype::sysmon:events:filecreated

# Change sourcetype of Sysmon Event ID 12 = registry key or value created or deleted
[sysmon-set-st-12]
REGEX=^<Sysmon Type="12"
DEST_KEY=MetaData:Sourcetype
FORMAT=sourcetype::sysmon:events:registrycreatedel

# Change sourcetype of Sysmon Event ID 13 = registry value set
[sysmon-set-st-13]
REGEX=^<Sysmon Type="13"
DEST_KEY=MetaData:Sourcetype
FORMAT=sourcetype::sysmon:events:registryvalueset

# Change sourcetype of Sysmon Event ID 14 = registry key or value renamed
[sysmon-set-st-14]
REGEX=^<Sysmon Type="14"
DEST_KEY=MetaData:Sourcetype
FORMAT=sourcetype::sysmon:events:registryrename

# Change sourcetype of Sysmon Event ID 15 = file create stream hash. Named file stream created, contains hashes of creator and content.
[sysmon-set-st-15]
REGEX=^<Sysmon Type="15"
DEST_KEY=MetaData:Sourcetype
FORMAT=sourcetype::sysmon:events:filecreatestream

# Change sourcetype of Sysmon Event ID 16 = sysmon configuration changed
[sysmon-set-st-16]
REGEX=^<Sysmon Type="16"
DEST_KEY=MetaData:Sourcetype
FORMAT=sourcetype::sysmon:events:configchange

# Change sourcetype of Sysmon Event ID 17 = named pipe created
[sysmon-set-st-17]
REGEX=^<Sysmon Type="17"
DEST_KEY=MetaData:Sourcetype
FORMAT=sourcetype::sysmon:events:pipecreated

# Change sourcetype of Sysmon Event ID 18 = named pipe connected
[sysmon-set-st-18]
REGEX=^<Sysmon Type="18"
DEST_KEY=MetaData:Sourcetype
FORMAT=sourcetype::sysmon:events:pipeconnected

# Change sourcetype of Sysmon Event ID 19 = wmi event filter registered
[sysmon-set-st-19]
REGEX=^<Sysmon Type="19"
DEST_KEY=MetaData:Sourcetype
FORMAT=sourcetype::sysmon:events:wmifilterregistered

# Change sourcetype of Sysmon Event ID 20 = wmi event consumer registered
[sysmon-set-st-20]
REGEX=^<Sysmon Type="20"
DEST_KEY=MetaData:Sourcetype
FORMAT=sourcetype::sysmon:events:wmiconsumerregistered

# Change sourcetype of Sysmon Event ID 21 = wmi consumer binds to a filter
[sysmon-set-st-21]
REGEX=^<Sysmon Type="21"
DEST_KEY=MetaData:Sourcetype
FORMAT=sourcetype::sysmon:events:wmiconsumerbindfilter

# Change sourcetype of Sysmon Event ID 22 = dns query
[sysmon-set-st-22]
REGEX=^<Sysmon Type="22"
DEST_KEY=MetaData:Sourcetype
FORMAT=sourcetype::sysmon:events:dnsquery

# Change sourcetype of Sysmon Event ID 255 = sysmon error
[sysmon-set-st-255]
REGEX=^<Sysmon Type="255"
DEST_KEY=MetaData:Sourcetype
FORMAT=sourcetype::sysmon:events:error


# Separate network events
#[sysmon-index-split]
#REGEX = ^<Sysmon [^>]*Type="(3|22)"
#DEST_KEY = _MetaData:Index
#FORMAT = sysmon_network

#-----------------------------------------------
# Sysmon: Search time extractions

# For the original format WinEventLog format, for backwards compatibility, header fields:

[sysmon-wineventlog-header]
REGEX = ^<Event .*?<EventID>(\d+)</EventID>.*?<Level>(\d+)</Level>.*?<TimeCreated SystemTime='(.*?)'/><EventRecordID>(\d+)</EventRecordID>.*?<Channel>(.*?)</Channel><Computer>(.*?)</Computer><Security UserID='(S-[0-9a-fA-f-]+)'/>
FORMAT = EventCode::$1 Level::$2 TimeCreated::$3 event_id::$4 Channel::$5 Computer::$6 SecurityID::$7


#-------------------
# sourcetype sysmon:events*

[sysmon-signatureid]
REGEX = ^<Sysmon Type="([0-9]+)" RecID="([0-9]+)"
FORMAT = EventCode::$1 event_id::$2
CLEAN_KEYS = 0


#-------------------
# Lookups

[sysmon_eventcodes]
filename = sysmon_eventcodes.csv
max_matches = 1
#min_matches = 1
#default_match = Unknown

[sysmon_direction]
filename = sysmon_direction.csv
max_matches = 1

[sysmon_eventtype_lookup]
filename = sysmon_eventtype_lookup.csv
max_matches = 1

[sysmon_state_lookup]
filename = sysmon_state_lookup.csv
max_matches = 1


#-------------------
# EventData

[sysmon-data]
REGEX = <Data Name='(.*?)'>(.*?)</Data>
FORMAT = $1::$2

[sysmon-md5]
REGEX = MD5\=([a-fA-F0-9]{32}?)
FORMAT = MD5::$1

[sysmon-sha1]
REGEX = SHA1\=([a-fA-F0-9]{40}?)
FORMAT = SHA1::$1

[sysmon-sha256]
REGEX = SHA256\=([a-fA-F0-9]{64}?)
FORMAT = SHA256::$1

[sysmon-imphash]
REGEX = IMPHASH\=([a-fA-F0-9]{32}?)
FORMAT = IMPHASH::$1

# keys: Hashes, Hash, ConfigurationFileHash
[sysmon-Hashes]
SOURCE_KEY = Hashes
REGEX = (?<file_hash>[A-Fa-f0-9]{32,})
MV_ADD = true
REPEAT_MATCH=true

[sysmon-Hash]
SOURCE_KEY = Hash
REGEX = (?<file_hash>[A-Fa-f0-9]{32,})
MV_ADD = true
REPEAT_MATCH=true

[sysmon-ConfigurationFileHash]
SOURCE_KEY = Hash
REGEX = (?<file_hash>[A-Fa-f0-9]{32,})
MV_ADD = true
REPEAT_MATCH=true


[sysmon-process-params]
CLEAN_KEYS = 0
REGEX = ^(?<process_cmdline_bin>([^\s\"]+|\"[^\"]+\"))\s(?<process_params>.*)
SOURCE_KEY = CommandLine

[sysmonupd-config-filename]
CLEAN_KEYS = 0
REGEX = (?<config_filename>[^\\\\]+)$
SOURCE_KEY = config

[sysmon-parent-process-params]
CLEAN_KEYS = 0
REGEX = ^(?<parent_process_cmdline_bin>([^\s\"]+|\"[^\"]+\"))\s(?<parent_process_params>.*)
SOURCE_KEY = ParentCommandLine

[sysmon-parent-process-image]
CLEAN_KEYS = 0
REGEX = ^(?<parent_process_path>.*\\)?(?<parent_process>.*)
SOURCE_KEY = ParentImage

#[sysmon-parent-process-name]
#CLEAN_KEYS = 0
#REGEX = ^(.*\\)?(?<parent_process_name>[^\\]*?)(\.[^.\\]+)?$
#SOURCE_KEY = parent_process

[sysmon-process-path]
CLEAN_KEYS = 0
REGEX = ^(?<process_path>.*\\)?(?<process>.*)
SOURCE_KEY = Image

[sysmon-target-process]
CLEAN_KEYS = 0
REGEX = ^(?<target_process_path>.*\\)?(?<target_process>.*)
SOURCE_KEY = TargetImage

[sysmon-target-process-name]
CLEAN_KEYS = 0
REGEX = ^(.*\\)?(?<target_process_name>[^\\]*?)(\.[^.\\]+)?$
SOURCE_KEY = target_process

[sysmon-source-image]
CLEAN_KEYS = 0
REGEX = ^(?<process_path>.*\\)?(?<process>.*)
SOURCE_KEY = SourceImage

[sysmon-process-name]
SOURCE_KEY = process
REGEX = ^(?<process_name>.*?)(?:\.[^\.]+)?$
CLEAN_KEYS = 0

[sysmon-targetfilename]
SOURCE_KEY = TargetFilename
REGEX = (?<file_path>.*\\)?(?<file_name>[^\\]+)$
CLEAN_KEYS = 0

[sysmon-imageloaded-file-name-path]
SOURCE_KEY = ImageLoaded
REGEX = ^(?<file_path>.+\\)(?<file_name>[^\\]+)$
CLEAN_KEYS = 0

[sysmon-target-start-module]
CLEAN_KEYS = 0
REGEX = ^(?<target_start_module_path>.+\\)(?<target_start_module_file>[^\\]+)$
SOURCE_KEY = StartModule

[sysmon-registry-targetobject]
SOURCE_KEY = TargetObject
REGEX = (?<object_path>.*\\)?(?<object_name>[^\\]+)$

# DeleteKey/CreateKey/RenameKey: hive\path
# DeleteValue/SetValue: hive\path\value
[sysmon-registry-path]
SOURCE_KEY = TargetObject
#REGEX = ^(?<registry_hive>[^\\]+)\\(?<registry_path_1>.+\\)(?<registry_key_name>[^\\]+)\\(?<registry_value_name>[^\\]+)$
REGEX = ^(?<registry_hive>[^\\]+)\\(?<sm_registry_path_1>.+\\)(?<sm_registry_path_2>[^\\]+)\\(?<sm_registry_path_3>[^\\]+)$
#REGEX = ^(?<registry_hive>[^\\]+)\\(?<registry_path>.+)

#[sysmon-registry-key-name]
#SOURCE_KEY = registry_path
#REGEX = (?<registry_path_>[^\\]+)$

# DNS query, event 22:
# QueryName, QueryType, QueryStatus, QueryResults
# type: 5 emea.presence.services.sfb.trafficmanager.net;type: 5 presence.northeurope.cloudapp.azure.com;52.114.77.0;40.90.4.201;40.90.4.201;64.4.48.201;13.107.160.201;
# 34.214.14.104;52.42.209.236;52.42.16.199;205.251.193.121;205.251.194.102;205.251.196.236;205.251.199.194;
[sysmon-dns-query-results]
SOURCE_KEY = QueryResults
REGEX = ([^;]+)
FORMAT = answer_all::$1
MV_ADD = true

[sysmon-dns-query-results-alias]
SOURCE_KEY = QueryResults
REGEX = type:\s+5\s+([^ ;]+);
FORMAT = answer_alias::$1
MV_ADD = true

[sysmon-dns-query-results-ip]
SOURCE_KEY = QueryResults
REGEX = (?:^|;)(?:::ffff:)?([^ ;]+);
FORMAT = answer::$1
MV_ADD = true

#[sysmon-dns-query-results-other]
#SOURCE_KEY = QueryResults
#REGEX = (type:\s+(?!5)[^;]+);
#FORMAT = answer_other::$1
#MV_ADD = true


#--------------------
# Extractions for Sysmon update script output

[sysmonupd-filename]
REGEX = Updating sysmon configuration from \"(?<filename>.*?)\"

[sysmonupd-filesize]
REGEX = Size of new configuration file: (?<filesize>.*?)\r?\n

[sysmonupd-schema-version]
REGEX = with schema version (?<sysmon_schema_version>[^ \r\n]+)

[sysmonupd-version]
REGEX = System Monitor v(?<sysmon_version>[^ \r\n]+)
